<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js oranda-dark">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>SFASTA</title>
        <meta name="robots" content="noindex" />


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">
        <link rel="stylesheet" href="oranda-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="mdbook-admonish.css">
        <link rel="stylesheet" href="mdbook-admonish.css">
        <link rel="stylesheet" href="mdbook-admonish.css">

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "oranda-dark" : "oranda-dark";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('orandamdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('orandamdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('orandamdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('oranda-dark')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="about.html"><strong aria-hidden="true">1.</strong> About</a></li><li class="chapter-item expanded "><a href="file_format.html"><strong aria-hidden="true">2.</strong> Format</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="oranda-dark">Oranda Dark</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="oranda-light">Oranda Light</button></li>

                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">SFASTA</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="about"><a class="header" href="#about">About</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="file-format"><a class="header" href="#file-format">File Format</a></h1>
<p>The SFASTA format is held together by <a href="https://github.com/bincode-org/bincode">bincode</a>, which serializes structs and other data to the file.</p>
<p>Unlike many other formats, SFASTA is written more similar to a database, and meant to be crawled to properly understand. Linear processing will be difficult, and provide no benefits. Once the directory is read, it is possible to seek to the file location to prase the next bit of data.</p>
<p>It also means if the order of the data changes, the file format remains stable, assuming the directory remains in the same location at the head of the file.</p>
<h2 id="file-format-1"><a class="header" href="#file-format-1">File Format</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td>Header</td><td>str</td><td>b"SFASTA" - The "Magic Bytes"</td></tr>
<tr><td>Version</td><td>u64</td><td>Indicates the version, for future compatability</td></tr>
<tr><td>Directory</td><td><a href="file_format.html#directory">Directory</a></td><td>Locations of index, sequences, masking, etc...</td></tr>
<tr><td>Parameters</td><td><a href="file_format.html#parameters">Parameters</a></td><td>Parameters used to create the file</td></tr>
<tr><td>Metadata</td><td><a href="file_format.html#metadata">Metadata</a></td><td>Metadata about the file</td></tr>
<tr><td>Compressed Blocks</td><td><a href="file_format.html#compressed-blocks">Compressed Blocks</a></td><td>Individual compressed blocks</td></tr>
<tr><td>Block Locations</td><td><a href="file_format.html#fractal-tree">Fractal tree</a></td><td>Stored in this order: headers, ids, masking, sequences, scores</td></tr>
<tr><td>Headers</td><td><a href="file_format.html#block-store-headers">Block Store Headers</a></td><td>Stored in the following order: Headers, IDs, Masking, Sequences, Scores</td></tr>
</tbody></table>
</div>
<h2 id="directory"><a class="header" href="#directory">Directory</a></h2>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">Field</th><th style="text-align: center">Type</th><th style="text-align: center">Description</th></tr></thead><tbody>
<tr><td style="text-align: center">Index Loc</td><td style="text-align: center">u64</td><td style="text-align: center">Location of the Index Fractal Tree</td></tr>
<tr><td style="text-align: center">IDs Loc</td><td style="text-align: center">u64</td><td style="text-align: center">Location of the ID Block Store Headers</td></tr>
<tr><td style="text-align: center">SeqLocs Loc</td><td style="text-align: center">u64</td><td style="text-align: center">Location of the SeqLocs Store Headers</td></tr>
<tr><td style="text-align: center">Scores Loc</td><td style="text-align: center">u64</td><td style="text-align: center">Location of the quality scores store headers</td></tr>
<tr><td style="text-align: center">Masking Loc</td><td style="text-align: center">u64</td><td style="text-align: center">Location of the masking store headers</td></tr>
<tr><td style="text-align: center">Headers loc</td><td style="text-align: center">u64</td><td style="text-align: center">Location of the headers store headers</td></tr>
<tr><td style="text-align: center">Sequences Loc</td><td style="text-align: center">u64</td><td style="text-align: center">Location of the sequences stores headers</td></tr>
<tr><td style="text-align: center">Flags Loc</td><td style="text-align: center">u64</td><td style="text-align: center">Not yet implemented</td></tr>
<tr><td style="text-align: center">Signals Loc</td><td style="text-align: center">u64</td><td style="text-align: center">Not yet implemented</td></tr>
<tr><td style="text-align: center">Mods Loc</td><td style="text-align: center">u64</td><td style="text-align: center">Not yet implemented</td></tr>
</tbody></table>
</div>
<p>For all directory entries, 0 indicates None.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[derive(Debug, Clone, Default, PartialEq, Eq)]
pub struct Directory
{
    pub index_loc: Option&lt;NonZeroU64&gt;,
    pub ids_loc: Option&lt;NonZeroU64&gt;,
    pub seqlocs_loc: Option&lt;NonZeroU64&gt;,
    pub scores_loc: Option&lt;NonZeroU64&gt;,
    pub masking_loc: Option&lt;NonZeroU64&gt;,
    pub headers_loc: Option&lt;NonZeroU64&gt;,
    pub sequences_loc: Option&lt;NonZeroU64&gt;,
    pub flags_loc: Option&lt;NonZeroU64&gt;,
    pub signals_loc: Option&lt;NonZeroU64&gt;,
    pub mods_loc: Option&lt;NonZeroU64&gt;,
}
<span class="boring">}</span></code></pre></pre>
<h2 id="parameters"><a class="header" href="#parameters">Parameters</a></h2>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">Field</th><th style="text-align: center">Type</th><th style="text-align: center">Description</th></tr></thead><tbody>
<tr><td style="text-align: center">block size</td><td style="text-align: center">u32</td><td style="text-align: center">Block size used for storage.</td></tr>
</tbody></table>
</div>
<p>Likely to be removed, and headers to store block size for each individual data type.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[derive(Debug, Clone, bincode::Encode, bincode::Decode)]
pub struct Parameters
{
    pub block_size: u32,
}
<span class="boring">}</span></code></pre></pre>
<h2 id="metadata"><a class="header" href="#metadata">Metadata</a></h2>
<p>Metadata is stored uncompressed, so that the files can be found with grep and metadata rapidly accessed. These are all open ended, and formats are not enforced.</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">Field</th><th style="text-align: center">Type</th><th style="text-align: center">Description</th></tr></thead><tbody>
<tr><td style="text-align: center">created_by</td><td style="text-align: center">Option<String></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">citation_doi</td><td style="text-align: center">Option<String></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">citation_url</td><td style="text-align: center">Option<String></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">citation_authors</td><td style="text-align: center">Option<String></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">date_created</td><td style="text-align: center">Option<String></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">title</td><td style="text-align: center">Option<String></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">description</td><td style="text-align: center">Option<String></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">notes</td><td style="text-align: center">Option<String></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">download_url</td><td style="text-align: center">Option<String></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">homepage_url</td><td style="text-align: center">Option<String></td><td style="text-align: center"></td></tr>
<tr><td style="text-align: center">version</td><td style="text-align: center">Option<String></td><td style="text-align: center"></td></tr>
</tbody></table>
</div>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[derive(
    Debug,
    Clone,
    bincode::Encode,
    bincode::Decode,
    Default,
    Serialize,
    Deserialize,
)]
pub struct Metadata
{
    pub created_by: Option&lt;String&gt;,
    pub citation_doi: Option&lt;String&gt;,
    pub citation_url: Option&lt;String&gt;,
    pub citation_authors: Option&lt;String&gt;,
    pub date_created: u64,
    pub title: Option&lt;String&gt;,
    pub description: Option&lt;String&gt;,
    pub notes: Option&lt;String&gt;,
    pub download_url: Option&lt;String&gt;,
    pub homepage_url: Option&lt;String&gt;,
    pub version: Option&lt;usize&gt;,
}
<span class="boring">}</span></code></pre></pre>
<h2 id="compressed-blocks"><a class="header" href="#compressed-blocks">Compressed Blocks</a></h2>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">Field</th><th style="text-align: center">Type</th><th style="text-align: center">Description</th></tr></thead><tbody>
<tr><td style="text-align: center">data</td><td style="text-align: center">Vec u8</td><td style="text-align: center"></td></tr>
</tbody></table>
</div>
<p>Data is converted when the block size is reached, or if the file processing is complete. Data is converted to bytes (u8) depending on the store being used (Strings, Masking, etc).</p>
<p>Data is bincoded to Vec u8 , the block is individually compressed, and bincoded into the file as Vec u8.</p>
<h2 id="block-store-headers"><a class="header" href="#block-store-headers">Block Store Headers</a></h2>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">Field</th><th style="text-align: center">Type</th><th style="text-align: center">Description</th></tr></thead><tbody>
<tr><td style="text-align: center">Compression Config</td><td style="text-align: center"><a href="file_format.html#compression-config">CompressionConfig</a></td><td style="text-align: center">Configuration for this datatype</td></tr>
<tr><td style="text-align: center">Location of the Blocks Fractal Tree Index</td><td style="text-align: center"><a href="file_format.html#fractal-tree">FractalTree</a></td><td style="text-align: center">Location of the Fractal Tree</td></tr>
<tr><td style="text-align: center">Block Size</td><td style="text-align: center">u32</td><td style="text-align: center">Size of uncompressed blocks for this data type</td></tr>
</tbody></table>
</div>
<h2 id="compression-config"><a class="header" href="#compression-config">Compression Config</a></h2>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">Field</th><th style="text-align: center">Type</th><th style="text-align: center">Description</th></tr></thead><tbody>
<tr><td style="text-align: center">Compression Type</td><td style="text-align: center">enum</td><td style="text-align: center"><a href="file_format.html#compression-type">Compression Type</a></td></tr>
<tr><td style="text-align: center">Compression Level</td><td style="text-align: center">i8</td><td style="text-align: center">Compression level to use for this data type</td></tr>
</tbody></table>
</div>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct CompressionConfig
{
    pub compression_type: CompressionType,
    pub compression_level: i8,

    #[serde(skip)]
    pub compression_dict: Option&lt;Vec&lt;u8&gt;&gt;,
}
<span class="boring">}</span></code></pre></pre>
<h2 id="compression-type"><a class="header" href="#compression-type">Compression Type</a></h2>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[derive(
    PartialEq,
    Eq,
    Debug,
    Clone,
    Copy,
    bincode::Encode,
    bincode::Decode,
    Serialize,
    Deserialize,
)]
#[non_exhaustive]
pub enum CompressionType
{
    ZSTD,   // 1 should be default compression ratio
    LZ4,    // 9 should be default compression ratio
    SNAPPY, // Implemented
    GZIP,   // Implemented
    NONE,   // No Compression
    XZ,     // Implemented, 6 is default ratio
    BROTLI, // Implemented, 6 is default
    BZIP2,  // Implemented
    BIT2,   // Not implemented
    BIT4,   // Not implemented
}
<span class="boring">}</span></code></pre></pre>
<h2 id="fractal-tree"><a class="header" href="#fractal-tree">Fractal Tree</a></h2>
<p>The fractal tree exists in two states, the Build state, and the OnDisk state. It is only stored as on disk.</p>
<p>Fractal Trees are made up of <a href="file_format.html#nodes">Nodes</a></p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct FractalTreeDisk&lt;K: Key, V: Value&gt;
{
    pub root: NodeDisk&lt;K, V&gt;,
    pub start: u64, /* On disk position of the fractal tree, such that
                     * all locations are start + offset */
    pub compression: Option&lt;CompressionConfig&gt;,
}
<span class="boring">}</span></code></pre></pre>
<h3 id="node"><a class="header" href="#node">Node</a></h3>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">Field</th><th style="text-align: center">Type</th><th style="text-align: center">Description</th></tr></thead><tbody>
<tr><td style="text-align: center">is_root</td><td style="text-align: center">bool</td><td style="text-align: center">Is the root node?</td></tr>
<tr><td style="text-align: center">is_leaf</td><td style="text-align: center">bool</td><td style="text-align: center">Is a leaf node?</td></tr>
<tr><td style="text-align: center">state</td><td style="text-align: center">NodeState</td><td style="text-align: center">Is the node on the disk, or loaded into memory?</td></tr>
<tr><td style="text-align: center">keys</td><td style="text-align: center">Vec(k)</td><td style="text-align: center">Vector of the keys</td></tr>
<tr><td style="text-align: center">children</td><td style="text-align: center">Vec(NodeDisk)</td><td style="text-align: center">Children of this node (invalid if is_leaf)</td></tr>
<tr><td style="text-align: center">values</td><td style="text-align: center">Vec(V)</td><td style="text-align: center">Values of this leaf node, invalid if is_leaf is false</td></tr>
</tbody></table>
</div>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[derive(Debug, Clone)]
pub struct NodeDisk&lt;K, V&gt;
{
    pub is_root: bool,
    pub is_leaf: bool,
    pub state: NodeState,
    pub keys: Vec&lt;K&gt;,
    pub children: Option&lt;Vec&lt;Box&lt;NodeDisk&lt;K, V&gt;&gt;&gt;&gt;,
    pub values: Option&lt;Vec&lt;V&gt;&gt;,
}
<span class="boring">}</span></code></pre></pre>
<h3 id="node-state"><a class="header" href="#node-state">Node State</a></h3>
<p>Represents if the fractal tree node is currently on disk, compressed, or stored in memory (and thus accessible). If stored on disk, contains the location of the data.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[derive(Debug, Clone)]
pub enum NodeState
{
    InMemory,
    Compressed(Vec&lt;u8&gt;),
    OnDisk(u32),
}
<span class="boring">}</span></code></pre></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->
        <script src="mermaid.min.js"></script>
        <script src="mermaid-init.js"></script>

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
